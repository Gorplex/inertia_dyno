<!DOCTYPE html>
<html>
<head>
	<title>Inertia Dyno Live Feed</title>
	<link href="examples.css" rel="stylesheet" type="text/css">
	<script language="javascript" type="text/javascript" src="jquery.js"></script>
	<script language="javascript" type="text/javascript" src="jquery.flot.js"></script>
	<script language="javascript" type="text/javascript" src="jquery.flot.axislabels.js"></script>
	<script type="text/javascript">

	$(function() {

		var speed_plot = $.plot("#speed_plot", [ [0,0] ], {
			series: {
				shadowSize: 0,	// Drawing is faster without shadows
				lines: {
					fill: false,
					fillColor: "#077f35"
				}
			},
			axisLabels: {
				show: true
			},
			yaxis: {
				show: true,
				tickDecimals: 0
			},
			yaxes: [{
				axisLabel: 'Speed (rpm)',
				axisLabelPadding: 5
			}],
			xaxis: {
				show: true
			},
			xaxes: [{
				axisLabel: 'Time (s)',
				axisLabelPadding: 5
			}]
		});

		var torque_plot = $.plot("#torque_plot", [ [0,0] ], {
			series: {
				shadowSize: 0,	// Drawing is faster without shadows
				lines: {
					fill: false,
					fillColor: "#cccc00"
				}
			},
			axisLabels: {
				show: true
			},
			yaxis: {
				show: true,
				tickDecimals: 0
			},
			yaxes: [{
				axisLabel: 'Torque (Nm)',
				axisLabelPadding: 5
			}],
			xaxis: {
				show: true
			},
			xaxes: [{
				axisLabel: 'Time (s)',
				axisLabelPadding: 5
			}]
		});

	    var speed = [], 
	        torque = [], 
	        time = [], 
	        spd_plot = [], 
	        torq_plot = [],
	        sample_freq = 50,
	        plot_time_shown = 10
	        num_data_points = plot_time_shown*sample_freq
	        dyno_ws = new WebSocket("ws://localhost:8001/");


        dyno_ws.onmessage = function (event) {
            data = event.data;
            if (data[0] == "f") {
            	sample_freq = parseInt(data.slice(1));
            	num_data_points = sample_freq*plot_time_shown;
            }
            else if (data[0] == "s") { 
            	if (speed.length < num_data_points) {
            		speed.push(data.slice(1));
            	}
            	else {
            		speed = speed.slice(1);
            		speed.push(data.slice(1));
            	}
            }
            else if (data[0] == "T") {
            	if (torque.length < num_data_points) {
            		torque.push(data.slice(1));
            	}
            	else {
            		torque = torque.slice(1);
            		torque.push(data.slice(1));
            	}
            }
            else if (data[0] == "t") {
            	if (time.length < num_data_points) {
            		time.push(data.slice(1));
            	}
            	else {
            		time = time.slice(1);
            		time.push(data.slice(1));
            	}
            	// Format data arrays for plotting
            	if (spd_plot.length < num_data_points && torq_plot.length < num_data_points) {
            		spd_plot.push( [time[spd_plot.length-1],speed[spd_plot.length-1]] );
	           		torq_plot.push( [time[torq_plot.length-1],torque[torq_plot.length-1]] );
            	}
            	else {
            		spd_plot = spd_plot.slice(1);
            		torq_plot = torq_plot.slice(1);
            		spd_plot.push( [time[num_data_points-1],speed[num_data_points-1]] );
            		torq_plot.push( [time[num_data_points-1],torque[num_data_points-1]]);
            	}
            }
        };

		function draw_plots() {

			speed_plot.setData([{data: spd_plot, label: "Speed", color: "#077f35"}]);
			speed_plot.setupGrid();
			speed_plot.draw();

			torque_plot.setData([{data: torq_plot, label: "Torque", color: "#cccc00"}]);
			torque_plot.setupGrid();
			torque_plot.draw();

			setTimeout(draw_plots, 50);
		}

		draw_plots();
	});


	</script>
</head>
<body>

	<div id="header">
		<img src="smv_logo.png" width=100px height=100px float="left">
		<div id="header_title"><h2>Inertia Dyno Live Feed</h2></div>
	</div>

	<div id="content">

		<div class="demo-container">
			<div id="speed_plot" class="demo-placeholder"></div>
		</div>

		<div class="demo-container">
			<div id="torque_plot" class="demo-placeholder"></div>
		</div>

		<p>Time between updates: <input id="updateInterval" type="text" value="" style="text-align: right; width:5em"> milliseconds</p>

	</div>

	<div id="footer">
		Created by Alex Pink for the 2016-2017 Cal Poly Supermileage team.
	</div>

</body>
</html>
